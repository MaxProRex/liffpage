<!DOCTYPE html>
<html>
<head>
  <title>打卡定位</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>打卡定位</h2>
  <button onclick="startCheckIn()">打卡</button>
  <script>
    const WHITELIST = ['U79020fb63e5c20703ee2cb9f34c0df03', 'Uyyyyyyyyyy']; // 你的 LINE 使用者 ID 清單
    const GAS_WEBHOOK = 'https://script.google.com/macros/s/AKfycbzASDfmyeoqaX3vCorH8qQr-TCMDKYp-2X_AulwC94F2SnCfOusWeE0MixhrpJyEf5o/exec';
    const RENDER_WEBHOOK = 'https://line-location-bot.onrender.com/liff-checkin';

    async function startCheckIn() {
      await liff.init({ liffId: '2007367348-wz2VRNqM' });
      console.log('開始打卡流程');
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      const userId = profile.userId;
      const displayName = profile.displayName;
      console.log('取得 userId:', userId);
      console.log('取得 displayName:', displayName);
      console.log('白名單比對結果:', WHITELIST.includes(userId));
      if (!WHITELIST.includes(userId)) {
        alert('您不在打卡清單中');
        return;
      }
      console.log('白名單比對結果:', WHITELIST.includes(userId));
      navigator.geolocation.getCurrentPosition(function(position) {
        const payload = {
          userId,
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          timestamp: new Date().toISOString()
        };

        //fetch(GAS_WEBHOOK, {
        fetch(RENDER_WEBHOOK, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'application/json' }
        //}).then(res => {
          //console.log('GAS 回應:', res);
          //return res.json();
          //}).then(data => {
          //   console.log('GAS 回傳資料:', data);
          //   alert('打卡成功！');
          //}).catch(err => {
           //  console.error('打卡失敗:', err);
           //  alert('打卡失敗，請稍後再試');
          });       
      });
    }
  </script>
</body>
</html>
